name: Post to Bluesky

on:
  schedule:
    # Morning - Classic/Throwback (3pm UTC = 10am EST / 8am MT / 7am PST)
    - cron: '0 15 * * *'
    # Afternoon - Popular (6pm UTC = 1pm EST / 11am MT / 10am PST)
    - cron: '0 18 * * *'
    # Evening - Prestige (1am UTC = 8pm EST / 6pm MT / 5pm PST)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      slot:
        description: 'Which slot to post (morning, afternoon, evening)'
        required: true
        default: 'afternoon'
        type: choice
        options:
          - morning
          - afternoon
          - evening

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - name: Determine slot from schedule
        id: slot
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "slot=${{ inputs.slot }}" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" = "15" ]; then
              echo "slot=morning" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "18" ]; then
              echo "slot=afternoon" >> $GITHUB_OUTPUT
            else
              echo "slot=evening" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Post to Bluesky
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "https://texture.watch/api/cron/post-to-bluesky?slot=${{ steps.slot.outputs.slot }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Code: $http_code"

          if [ "$http_code" != "200" ]; then
            echo "Request failed with status $http_code"
            exit 1
          fi
